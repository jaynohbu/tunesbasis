<!-- ================= FILE UPLOAD ================= -->

<input
  type="file"
  accept="audio/*"
  (change)="onFileSelected($event)"
/>

<button
  (click)="upload()"
  [disabled]="!file || loading"
>
  {{ loading ? 'Working…' : 'Upload & Analyze' }}
</button>

<!-- ================= PROGRESS BAR ================= -->

<div *ngIf="loading" class="progress">
  <div
    class="bar"
    [class.upload]="progressMode === 'upload'"
    [class.processing]="progressMode === 'processing'"
    [style.width.%]="progress"
  ></div>

  <div class="label">
    {{ progressMode === 'upload'
      ? 'Uploading…'
      : 'Processing audio… (this may take a few minutes)' }}
  </div>
</div>

<!-- ================= GLOBAL CONTROLS ================= -->

<div *ngIf="stems.length" class="controls">
  <button (click)="togglePlay()">Play / Pause</button>

  <label>
    Master Volume
    <input
      type="range"
      min="0"
      max="1"
      step="0.01"
      [value]="globalVolume"
      (input)="setGlobalVolume($any($event.target).value)"
    />
  </label>
</div>

<!-- ================= STEM TRACKS ================= -->

<div *ngFor="let stem of stems" class="track">

  <div class="label">{{ stem.name }}</div>

  <!-- WAVEFORM -->
  <div
    class="wave-wrapper"
    (click)="seekFromWave($event)"
  >
    <canvas [attr.data-stem]="stem.name"></canvas>
    <div class="cursor" [style.left.%]="cursorPercent"></div>
  </div>

  <!-- BASIC CONTROLS -->
  <div class="controls">
    <label>
      Volume
      <input
        type="range"
        min="0"
        max="1"
        step="0.01"
        [value]="stemVolumes[stem.name]"
        (input)="setStemVolume(stem.name, $any($event.target).value)"
      />
    </label>

    <button
      (click)="toggleMute(stem.name)"
      [class.active]="stemMuted[stem.name]"
    >
      {{ stemMuted[stem.name] ? 'Unmute' : 'Mute' }}
    </button>
  </div>

  <!-- ================= KNOBS ================= -->

  <div class="knob-panel">

    <!-- PREGAIN -->
    <div class="knob-group">
      <div
        class="knob"
        [style.--rot]="stemKnobs[stem.name].pregain * 270 + 'deg'"
        (mousedown)="knobDrag($event, stem.name, 'pregain')"
        (dblclick)="resetKnob(stem.name, 'pregain')"
      ></div>
      <button (click)="resetKnob(stem.name, 'pregain')">Reset</button>
      <span>Pre</span>
    </div>

    <!-- COMPRESSION -->
    <div class="knob-group">
      <div
        class="knob"
        [style.--rot]="stemKnobs[stem.name].compression * 270 + 'deg'"
        (mousedown)="knobDrag($event, stem.name, 'compression')"
        (dblclick)="resetKnob(stem.name, 'compression')"
      ></div>
      <button (click)="resetKnob(stem.name, 'compression')">Reset</button>
      <span>Comp</span>
    </div>

    <!-- TONE -->
    <div class="knob-group">
      <div
        class="knob"
        [style.--rot]="stemKnobs[stem.name].tone * 270 + 'deg'"
        (mousedown)="knobDrag($event, stem.name, 'tone')"
        (dblclick)="resetKnob(stem.name, 'tone')"
      ></div>
      <button (click)="resetKnob(stem.name, 'tone')">Reset</button>
      <span>Tone</span>
    </div>

    <!-- DISTORTION (ONLY GUITAR / PIANO) -->
    <ng-container *ngIf="isDistortable(stem.name)">
      <div class="knob-group">
        <div
          class="knob"
          [style.--rot]="stemKnobs[stem.name].distortion * 270 + 'deg'"
          (mousedown)="knobDrag($event, stem.name, 'distortion')"
          (dblclick)="resetKnob(stem.name, 'distortion')"
        ></div>
        <button (click)="resetKnob(stem.name, 'distortion')">Reset</button>
        <span>Drive</span>
      </div>

      <!-- BYPASS -->
      <div class="led-group">
        <div
          class="led"
          [class.on]="!stemBypassLED[stem.name]"
          (click)="toggleBypassLED(stem.name)"
        ></div>
        <span>Bypass</span>
      </div>
    </ng-container>

  </div>
</div>
